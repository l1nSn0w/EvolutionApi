<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Webhooks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .card {
            transition: transform 0.3s;
            margin-bottom: 1rem;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stat-card {
            border-radius: 10px;
            padding: 20px;
            color: white;
        }
        .bg-gradient-primary {
            background: linear-gradient(45deg, #4e73df 0%, #224abe 100%);
        }
        .bg-gradient-success {
            background: linear-gradient(45deg, #1cc88a 0%, #13855c 100%);
        }
        .bg-gradient-info {
            background: linear-gradient(45deg, #36b9cc 0%, #258391 100%);
        }
        .bg-gradient-warning {
            background: linear-gradient(45deg, #f6c23e 0%, #dda20a 100%);
        }
        .message-row {
            cursor: pointer;
        }
        .message-row:hover {
            background-color: #f8f9fa;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .ad-info {
            background-color: #f8f9fc;
            border-left: 4px solid #4e73df;
            padding: 10px;
            margin-top: 10px;
        }
        .campaign-info {
            background-color: #f8f9fc;
            border-left: 4px solid #1cc88a;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingIndicator">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <i class="bi bi-activity"></i> Webhook Dashboard
                    </a>
                </div>
            </nav>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Filtrar Mensagens</h5>
                    </div>
                    <div class="card-body">
                        <form id="filterForm" class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Filtrar por data única</label>
                                <input type="text" class="form-control" id="singleDate" placeholder="Selecione uma data">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Data inicial</label>
                                <input type="text" class="form-control" id="startDate" placeholder="Data inicial">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Data final</label>
                                <input type="text" class="form-control" id="endDate" placeholder="Data final">
                            </div>
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-secondary" id="resetFilters">Limpar Filtros</button>
                                <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-xl-3 col-md-6">
                <div class="card stat-card bg-gradient-primary">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                    Total de Mensagens</div>
                                <div class="h5 mb-0 font-weight-bold" id="totalMessages">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-chat-dots fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card stat-card bg-gradient-success">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                    Encaminhadas</div>
                                <div class="h5 mb-0 font-weight-bold" id="totalForwarded">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-arrow-right-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card stat-card bg-gradient-info">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                    Android</div>
                                <div class="h5 mb-0 font-weight-bold" id="totalAndroid">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-android2 fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card stat-card bg-gradient-warning">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                    iOS</div>
                                <div class="h5 mb-0 font-weight-bold" id="totalIOS">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-apple fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Mensagens Recebidas</h5>
                        <div>
                            <span class="badge bg-light text-dark" id="messagesCount">0 mensagens</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Data/Hora</th>
                                        <th>Telefone</th>
                                        <th>Nome</th>
                                        <th>Dispositivo</th>
                                        <th>Encaminhada</th>
                                        <th>Anúncio</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="messagesTable">
                                    <!-- As mensagens serão inseridas aqui via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalhes da mensagem -->
    <div class="modal fade" id="messageDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Mensagem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ID:</strong> <span id="modalId"></span></p>
                            <p><strong>Telefone:</strong> <span id="modalTelefone"></span></p>
                            <p><strong>Nome:</strong> <span id="modalNome"></span></p>
                            <p><strong>Dispositivo:</strong> <span id="modalDispositivo"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Data/Hora Webhook:</strong> <span id="modalDateTime"></span></p>
                            <p><strong>Data/Hora Salvo:</strong> <span id="modalCreatedAt"></span></p>
                            <p><strong>Encaminhada:</strong> <span id="modalEncaminhado"></span></p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Mensagem:</h6>
                            <div class="p-3 bg-light rounded" id="modalMensagem">
                                <!-- Conteúdo da mensagem -->
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3" id="adSection">
                        <div class="col-12">
                            <h6>Dados do Anúncio:</h6>
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-end mb-2">
                                        <a href="#" id="modalFacebookLink" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="bi bi-facebook"></i> Ver no Facebook
                                        </a>
                                    </div>
                                    
                                    <p><strong>Source ID:</strong> <span id="modalSourceId"></span></p>
                                    <p><strong>Título:</strong> <span id="modalTitle"></span></p>
                                    <p><strong>URL:</strong> <a href="#" id="modalUrl" target="_blank"></a></p>
                                    
                                    <div class="ad-info mt-3">
                                        <h6><i class="bi bi-megaphone"></i> Informações do Anúncio:</h6>
                                        <p><strong>Nome do Anúncio:</strong> <span id="modalAdName"></span></p>
                                    </div>
                                    
                                    <div class="ad-info mt-3">
                                        <h6><i class="bi bi-collection"></i> Conjunto de Anúncios:</h6>
                                        <p><strong>ID do Conjunto:</strong> <span id="modalAdsetId"></span></p>
                                        <p><strong>Nome do Conjunto:</strong> <span id="modalAdsetName"></span></p>
                                    </div>
                                    
                                    <div class="campaign-info mt-3">
                                        <h6><i class="bi bi-bullseye"></i> Campanha:</h6>
                                        <p><strong>ID da Campanha:</strong> <span id="modalCampaignId"></span></p>
                                        <p><strong>Nome da Campanha:</strong> <span id="modalCampaignName"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    
    <script>
        // Configurar seletores de data
        flatpickr("#singleDate", {
            dateFormat: "Y-m-d",
            locale: "pt"
        });
        flatpickr("#startDate", {
            dateFormat: "Y-m-d",
            locale: "pt"
        });
        flatpickr("#endDate", {
            dateFormat: "Y-m-d",
            locale: "pt"
        });

        // Elementos DOM
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messagesTable = document.getElementById('messagesTable');
        const messagesCount = document.getElementById('messagesCount');
        const totalMessages = document.getElementById('totalMessages');
        const totalForwarded = document.getElementById('totalForwarded');
        const totalAndroid = document.getElementById('totalAndroid');
        const totalIOS = document.getElementById('totalIOS');
        const filterForm = document.getElementById('filterForm');
        const resetFiltersBtn = document.getElementById('resetFilters');
        
        // Modal de detalhes
        const messageDetailModal = new bootstrap.Modal(document.getElementById('messageDetailModal'));
        
        // Estado da aplicação
        let currentMessages = [];

        // Carregar mensagens ao iniciar
        document.addEventListener('DOMContentLoaded', () => {
            loadMessages();
            
            // Adicionar eventos
            filterForm.addEventListener('submit', (e) => {
                e.preventDefault();
                loadMessages();
            });
            
            resetFiltersBtn.addEventListener('click', () => {
                document.getElementById('singleDate').value = '';
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                loadMessages();
            });
        });

        // Função para carregar mensagens
        function loadMessages() {
            loadingIndicator.style.display = 'flex';
            
            // Construir a URL com os filtros
            const singleDate = document.getElementById('singleDate').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let apiUrl = '/messages';
            const params = new URLSearchParams();
            
            if (singleDate) {
                params.append('date', singleDate);
            } else if (startDate && endDate) {
                params.append('start_date', startDate);
                params.append('end_date', endDate);
            }
            
            if (params.toString()) {
                apiUrl += `?${params.toString()}`;
            }
            
            // Fetch API para obter dados
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Armazenar mensagens
                        currentMessages = data.messages;
                        
                        // Atualizar contadores
                        updateCounters(data.messages);
                        
                        // Preencher tabela
                        renderMessagesTable(data.messages);
                        
                        // Atualizar contagem de mensagens
                        messagesCount.textContent = `${data.count} mensagens`;
                    } else {
                        alert('Erro ao carregar mensagens: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar mensagens:', error);
                    alert('Erro ao carregar mensagens. Verifique o console para mais detalhes.');
                })
                .finally(() => {
                    loadingIndicator.style.display = 'none';
                });
        }

        // Atualizar contadores
        function updateCounters(messages) {
            totalMessages.textContent = messages.length;
            
            const forwarded = messages.filter(msg => msg.encaminhado_make).length;
            totalForwarded.textContent = forwarded;
            
            const android = messages.filter(msg => msg.dispositivo.toLowerCase() === 'android').length;
            totalAndroid.textContent = android;
            
            const ios = messages.filter(msg => msg.dispositivo.toLowerCase() === 'ios').length;
            totalIOS.textContent = ios;
        }

        // Renderizar tabela de mensagens
        function renderMessagesTable(messages) {
            messagesTable.innerHTML = '';
            
            if (messages.length === 0) {
                messagesTable.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">Nenhuma mensagem encontrada.</td>
                    </tr>
                `;
                return;
            }
            
            messages.forEach(msg => {
                const row = document.createElement('tr');
                row.className = 'message-row';
                row.dataset.messageId = msg.id;
                
                // Formatar data/hora
                const dateTime = msg.date_time ? new Date(msg.date_time).toLocaleString('pt-BR') : 'N/A';
                
                // Informação do anúncio (resumida)
                let adInfo = 'N/A';
                if (msg.ad_name) {
                    adInfo = `<span class="badge bg-info">${msg.ad_name}</span>`;
                } else if (msg.source_id) {
                    adInfo = `<span class="badge bg-secondary">${msg.source_id}</span>`;
                }
                
                row.innerHTML = `
                    <td>${msg.id}</td>
                    <td>${dateTime}</td>
                    <td>${msg.telefone}</td>
                    <td>${msg.nome}</td>
                    <td>${msg.dispositivo}</td>
                    <td>
                        ${msg.encaminhado_make 
                            ? '<span class="badge bg-success">Sim</span>' 
                            : '<span class="badge bg-danger">Não</span>'}
                    </td>
                    <td>${adInfo}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary view-details" data-id="${msg.id}">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                `;
                
                messagesTable.appendChild(row);
            });
            
            // Adicionar eventos para botões de visualização
            document.querySelectorAll('.view-details').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    showMessageDetails(id);
                });
            });
        }

        // Exibir detalhes da mensagem
        function showMessageDetails(id) {
            const message = currentMessages.find(msg => msg.id.toString() === id.toString());
            
            if (!message) {
                alert('Mensagem não encontrada!');
                return;
            }
            
            // Preencher informações básicas
            document.getElementById('modalId').textContent = message.id;
            document.getElementById('modalTelefone').textContent = message.telefone;
            document.getElementById('modalNome').textContent = message.nome;
            document.getElementById('modalDispositivo').textContent = message.dispositivo;
            
            // Datas
            document.getElementById('modalDateTime').textContent = message.date_time 
                ? new Date(message.date_time).toLocaleString('pt-BR') 
                : 'N/A';
            document.getElementById('modalCreatedAt').textContent = message.created_at;
            
            // Status de encaminhamento
            document.getElementById('modalEncaminhado').innerHTML = message.encaminhado_make 
                ? '<span class="badge bg-success">Sim</span>' 
                : '<span class="badge bg-danger">Não</span>';
            
            // Mensagem
            document.getElementById('modalMensagem').textContent = message.mensagem || 'Sem conteúdo';
            
            // Seção de anúncio
            const adSection = document.getElementById('adSection');
            
            if (message.source_id) {
                adSection.style.display = 'block';
                
                // Link para o Facebook
                const fbLink = document.getElementById('modalFacebookLink');
                fbLink.href = `https://www.facebook.com/ads/library/?id=${message.source_id}`;
                
                // Informações básicas
                document.getElementById('modalSourceId').textContent = message.source_id;
                document.getElementById('modalTitle').textContent = message.title || 'N/A';
                
                const urlElement = document.getElementById('modalUrl');
                if (message.url) {
                    urlElement.href = message.url;
                    urlElement.textContent = message.url;
                } else {
                    urlElement.textContent = 'N/A';
                    urlElement.removeAttribute('href');
                }
                
                // Informações do anúncio do Facebook
                document.getElementById('modalAdName').textContent = message.ad_name || 'N/A';
                document.getElementById('modalAdsetId').textContent = message.adset_id || 'N/A';
                document.getElementById('modalAdsetName').textContent = message.adset_name || 'N/A';
                document.getElementById('modalCampaignId').textContent = message.campaign_id || 'N/A';
                document.getElementById('modalCampaignName').textContent = message.campaign_name || 'N/A';
                
            } else {
                adSection.style.display = 'none';
            }
            
            // Exibir modal
            messageDetailModal.show();
        }
    </script>
</body>
</html> 